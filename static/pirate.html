<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Pirate Ship</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				background:#fff;
				padding:0;
				margin:0;
				overflow:hidden;
			}

		</style>
	</head>
	<body>

		<div id="container"></div>

        <!-- todo bower? yarn? yargh? -->
		<script src="../src/three.js"></script>
		<script src="../src/ColladaLoader.js"></script>
        <script src="../src/Water.js"></script>

		<script>

			var container, clock;
			var camera, scene, renderer, ship, light, water,coin_geometry,coin_material;
            var coins = [];

           // for ocean	
            var parameters = {
				oceanSide: 2000,
				size: 1.0,
				distortionScale: 3.7,
				alpha: 1.0
			};
            var BOB_M = 0.1;
            var t = 0;

			init();
			animate();

			function init() {

				container = document.getElementById( 'container' );

				camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 0.1, 2000 );
				camera.position.set( 70, 50, 30 );
				camera.lookAt( new THREE.Vector3( 0, 3, 0 ) );

				scene = new THREE.Scene();

				clock = new THREE.Clock();

				// loading manager

				var loadingManager = new THREE.LoadingManager( function() {

					scene.add( ship );

				} );

				// collada ship

				var loader = new THREE.ColladaLoader( loadingManager );
				loader.load( '../assets/pirateship.dae', function ( collada ) {

					ship = collada.scene;

				} );


				var ambientLight = new THREE.AmbientLight( 0xcccccc, 0.8 );
				scene.add( ambientLight );

				var directionalLight = new THREE.DirectionalLight( 0xffffff, 0.8 );
                light = directionalLight;
				directionalLight.position.set( 1, 1, 0 ).normalize();
				scene.add( directionalLight );


                setWater();
                setSkybox();

                for(var i=0;i<5; i++){
                    addCoin(Math.random()*30,10,Math.random()*30);
                }
				//

				renderer = new THREE.WebGLRenderer();
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				container.appendChild( renderer.domElement );

                addSoundEffects();

				window.addEventListener( 'resize', onWindowResize, false );

			}

            function addCoin(x,y,z){
                //if( coin_geometry == null){
                 var coin_geometry = new THREE.CylinderGeometry( 1, 1, 0.5, 20, 3 );
                 var coin_material = new THREE.MeshBasicMaterial( {color: 0xffff00} );
                //}
                var coin = new THREE.Mesh( coin_geometry, coin_material );
                coin.position.x = x;
                coin.position.y = y;
                coin.position.z = z;
                coin.rotation.x = Math.PI / 2;
                coins.push(coin)

                scene.add( coin );
            }

            function addSoundEffects(){
                // ocean sound from https://freesound.org/people/DANMITCH3LL/sounds/240204/
                //Create an AudioListener and add it to the camera
                var listener = new THREE.AudioListener();
                camera.add( listener );
                
                // create a global audio source
                var sound = new THREE.Audio( listener );
                
                var audioLoader = new THREE.AudioLoader();
                
                //Load a sound and set it as the Audio object's buffer
                audioLoader.load( '../assets/sounds/ocean-waves.ogg', function( buffer ) {
                	sound.setBuffer( buffer );
                	sound.setLoop( true );
                	sound.setVolume( 0.5 );
                	sound.play();
                });
            }

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			function animate() {

				requestAnimationFrame( animate );

				render();

			}

			function render() {

				var delta = clock.getDelta();
                var t = clock.getElapsedTime();
				if ( ship !== undefined ) {

					ship.rotation.y = Math.sin(t) * BOB_M; 

				}

                for(var c=0; c<coins.length; c++){
                    coins[c].rotation.z += delta * 2 ;
                }

                water.material.uniforms.time.value += 1.0 / 200.0;
				water.material.uniforms.size.value = parameters.size;
				water.material.uniforms.distortionScale.value = parameters.distortionScale;
				water.material.uniforms.alpha.value = parameters.alpha;

				renderer.render( scene, camera );

			}

            function setWater() {
				water = new THREE.Water(
					parameters.oceanSide * 5,
					parameters.oceanSide * 5,
					{
						textureWidth: 512,
						textureHeight: 512,
						waterNormals: new THREE.TextureLoader().load( '../assets/img/waternormals.jpg', function ( texture ) {
							texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
						}),
						alpha: 	parameters.alpha,
						sunDirection: light.position.clone().normalize(),
						sunColor: 0xffffff,
						waterColor: 0x001e0f,
						distortionScale: parameters.distortionScale,
						fog: scene.fog != undefined
					}
				);
				water.rotation.x = - Math.PI / 2;
				water.receiveShadow = true;
				scene.add( water );
			}

			function setSkybox() {
				cubeMap = new THREE.CubeTexture( [] );
				cubeMap.format = THREE.RGBFormat;
				var loader = new THREE.ImageLoader();
				loader.load( '../assets/img/skyboxsun25degtest.png', function ( image ) {
					var getSide = function ( x, y ) {
						var size = 1024;
						var canvas = document.createElement( 'canvas' );
						canvas.width = size;
						canvas.height = size;
						var context = canvas.getContext( '2d' );
						context.drawImage( image, - x * size, - y * size );
						return canvas;
					};
					cubeMap.images[ 0 ] = getSide( 2, 1 ); // px
					cubeMap.images[ 1 ] = getSide( 0, 1 ); // nx
					cubeMap.images[ 2 ] = getSide( 1, 0 ); // py
					cubeMap.images[ 3 ] = getSide( 1, 2 ); // ny
					cubeMap.images[ 4 ] = getSide( 1, 1 ); // pz
					cubeMap.images[ 5 ] = getSide( 3, 1 ); // nz
					cubeMap.needsUpdate = true;
				} );
				var cubeShader = THREE.ShaderLib[ 'cube' ];
				cubeShader.uniforms[ 'tCube' ].value = cubeMap;
				var skyBoxMaterial = new THREE.ShaderMaterial( {
					fragmentShader: cubeShader.fragmentShader,
					vertexShader: cubeShader.vertexShader,
					uniforms: cubeShader.uniforms,
					side: THREE.BackSide
				} );
				var skyBox = new THREE.Mesh(
					new THREE.BoxGeometry( parameters.oceanSide * 5 + 100, parameters.oceanSide * 5 + 100, parameters.oceanSide * 5 + 100 ),
					skyBoxMaterial
				);
				scene.add( skyBox );
			}
		</script>
	</body>
</html>

